\newcommand{\lczd}{\ensuremath\mathrm{\textsc{lczd}}}
\newcommand{\cps}{\ensuremath\mathrm{\textsc{cps}}}

\begin{figure*}
\vspace{5mm}
\begin{minipage}{0.32\textwidth}
\includegraphics[width=1.05\columnwidth]{figs/patching/durationdetection/durationdetection.eps}
\caption{Distribution of the time it takes to remap all overlapping paths.}
\label{fig:overlap.delay.cdf}
%
\end{minipage}
\hfill
\begin{minipage}{0.32\textwidth}
\includegraphics[width=1.05\columnwidth]{figs/patching/routesoverlapping/routesoverlapping.eps}
\caption{Fraction of monitored paths that overlap a routing event.}
\label{fig:overlap.quantity.cdf}
\end{minipage}
%
\hfill
\begin{minipage}{0.32\textwidth}
\includegraphics[width=1.05\columnwidth]{figs/patching/overlapcoverage/overlapcoverage_only_lczd.eps}
\caption{Prob.~of detecting change probing random radii in $\cps(q)$.}
\label{fig:lczd.intersection}
\end{minipage}
\end{figure*}

\section{Remapping Routing Events}
\label{sec:patching}

Routing events impact multiple paths in the Internet. Current
monitoring techniques monitor paths independently: detecting
a routing event on one Internet paths does not trigger any action on
other possibly-impacted paths.  This approach leads to outdated
routing information (as we do not remap other paths that have
changed due to the routing event) and prevents us from observing the
extent of a routing event (as another routing event might happen
before we remap all routes impacted by the first one).  We now
investigate whether we can use information about a just-remapped
change to efficiently (using few probes) detect and remap changes
the underlying routing event caused on other paths.

% Our goal is to
% develop techniques to efficiently (using few probes) identify and
% remap paths impacted by a routing event.

We define a \emph{local change zone domain}, denoted $\lczd(r')$,
for a change detected at radius $r'$ as the hops removed from the
previous path, $p_{i-1}$, around $r'$ plus the surrounding
divergence and convergence hops.  More formally, if $r_d$ and $r_c$
are the radii of the divergence and convergence hops, respectively,
and if $r^\prime_d = p_{i-1}\langle p_i[r_d]\rangle$ and $r^\prime_c
= p_{i-1}\langle p_i[r_c]\rangle$ are the radii of the divergence
and convergence hops on the previous path, then $\lczd(r')$ is
defined as the set of hops in $p_{i-1}$ between $r^\prime_d$ and
$r^\prime_c$, i.e., $\lczd(r') = \{p_{i-1}[x] \mid{} r^\prime_d \le
x \le r^\prime_c\}$.  A local change zone domain is similar to
a local change zone, but includes hops from the previous route
instead of hops from the new route.

\paragraphnd{Dataset.}  Upon detecting a path change at radius $r'$
on path $p_{i-1}$ (i.e., $p_i[r'] \ne p_{i-1}[r']$), \dtrack{}
immediately queues path $p_{i-1}$ to be remapped (remapping starts
immediately if there are no ongoing remaps).  We extended \dtrack{}
to collect data to study techniques for remapping paths after
detection of a \emph{routing event}.  After remapping of path
$p_{i-1}$ is complete, our extended \dtrack{} computes $\lczd(r')$
and proceeds to remap all other paths that could be impacted by the
routing event.  More precisely, \dtrack{} enqueues all (other)
\emph{overlapping paths} $q$ which intersect $\lczd(r')$, i.e., $q\,
\cap\,\lczd(r') \ne \emptyset$, for remapping (if not already
queued).  Although this approach does not guarantee \dtrack{} remaps
all paths impacted by the routing event, e.g., impacted paths that
are not monitored or that do not overlap $\lczd(r')$, it still
provides a more accurate snapshot of a routing event.  If \dtrack{}
detects a change in an overlapping path (remapped due to
a previously-detected routing event), \dtrack{} does not consider
the change a new routing event and does not enqueue paths for
remapping.  To prevent flapping routes and measurement noise from
constantly detecting routing events (and enqueuing path remaps),
\dtrack{} remaps at most four routing events per path over the last
24~hours.

We deployed the extended \dtrack{} on 80 PlanetLab nodes. We
generated a list of 12763 destinations including Alexa's TOP100
Websites (resolved from the 80 PlanetLab nodes), 2000 RIPE Atlas
probes chosen at random, and 10000 random reachable /24 prefixes.
The list of destinations covers 5715 ASes (computed using IP-to-AS
mapping information from iPlane). On each PlanetLab node, we
selected 1000 random IP addresses to be monitored.  The data used in
this analysis was collected between Jan.~27th and Mar.~7th, 2016 (40
days).

% Let us denote the routing event by $E(p_{i-1})$ and let
% $D(E(p_{i-1}))$ be the time spent to remap all overlapping routes.

Figure~\ref{fig:overlap.delay.cdf} shows the CDF, over all routing
events, of the time it takes to remap each event's overlapping
routes.  We round values to the nearest 5-minute boundary.  Because
we remap overlapping paths within a short period (usually within one
hour), there is a lower probability that subsequent routing events
will happen while the remap is ongoing.
Figure~\ref{fig:overlap.quantity.cdf} shows the CDF, over all
detected routing events, of the fraction of the 1000 monitored paths
that overlap with $\lczd(r')$.  We observe that 74\% of routing
events have at least one overlapping path, that most routing events
have a small (but significant) fraction of overlapping paths, and
that a few events (close to the monitoring node) impact all
monitored paths.

\paragraphnd{Efficient change detection.}  We want to find an
algorithm to identify whether an overlapping path has changed or
remained stable using few probes.  To this end, we consider sending
probes to overlapping paths at specific radii and checking for
a change.  Let $O(\lczd(r'), q)$ denote the overlap between the
local change zone domain $\lczd(r')$ for a routing event and an
overlapping path $q$, i.e., $\lczd(r')\cap{}q$.  We consider
a \emph{candidate probing set} $\cps(q)$ containing all radii
between the first (closest to the source) and last (furthest from
the source) hops in $O(\lczd(r'), q)$.  We consider all intermediate
radii, even though the hops at some intermediate radii may not be in
$\lczd(r')$,\footnotemark{} to guarantee $\cps(q)$ can detect all
path changes that overlap $\lczd(r')$.

\footnotetext{For example, due to a per-destination load
balancer~\cite{veitch09balancer}.}

We find that probing the divergence hop $p_{i-1}[r^\prime_d]$ on the
overlapping path (i.e., probing radii $q\langle p_{i-1}[r^\prime_d]
\rangle$) rarely detects a path change.  As a result, we do not
consider probing the divergence hop to detect a change and remove
its radii from $\cps(q)$.\footnotemark{}  We also find that probing
the convergence hop on the overlapping path also rarely detects
a change, \emph{except} for routing events that change the
convergence's hop radii by adding or removing hops to the route.  As
a result, we only consider probing the convergence hop for routing
events that change the route length and remove its radii from
$\cps(q)$ otherwise.

\footnotetext{The divergence hop $p_{i-1}[r^\prime_d]$ may not be in
$O(\lczd(r'), q)$.  This happens whenever $q$ does not traverse
$p_{i-1}[r^\prime_d]$.  In this case, $\cps(q)$ is unchanged.}

% Changes not related to $\lczd(r')$ are disconsidered from this
% analysis because we are unable to detect them based only in the
% information from the routing event.

% rarely no branch = 0.54%
% rarely no join onde nao muda o length = XXX%
% if we looking for join as described (different size lczd), 
% we have 13.5 million of overlaps that match the query (i.e., has join in the
% overlap). In overlaps that has a change, join is able to detect 75% of them.

\figstr~\ref{fig:lczd.intersection} shows, over all overlapping
paths that changed, the distribution of the fraction of radii in
$\cps(q)$ that can detect the change.  The distribution shows that
probing most radii in $\cps(q)$ will detect the change and
that, for 94\% of the overlapping paths that changed, probing
\emph{any} radii in $\cps(q)$ will detect the change.

\paragraphnd{Finding paths that change.} The results above show we
can identify, with high probability, whether an overlapping path has
changed or not with a single probe.  However, they only apply to the
20\% of overlapping paths that do change.  We now look at mechanisms
to efficiently identify which paths have changed and which have not.
\figstr~\ref{fig:overlap.change.prob} shows, over all routing
events, the fraction of overlapping paths that changed.  We group
overlapping paths on the $x$ axis by the size of the overlap $O$
relative to $\lczd(r')$, i.e., $|O|/|\lczd|$.  We note that the
bigger the overlap (i.e., when overlapping paths have more in common
with the change), the higher the probability that the overlapping
path will change.  

\paragraphnd{Reducing the number of probes with routing event.} We
now want to use the concept of a routing event defined
previously to improve the tracking path changes system
in \dtrack. As discussed before,\figstr~\ref{fig:overlap.quantity.cdf}  
shows that a routing event can have more than one overlapping path
which implies that overlapping paths can have the same
$\cps(q)$ in the same event which we define as $g(\cps(q))$
\figstr~\ref{fig:cps.change.prob} shows the probability of 
$g(\cps(q))$ changes, i.e., $|changes(g(\cps(q)))|/|g(\cps(q))|$. 
We note that 85\% of all CPS are in $g(\cps(q))$ that have a uniform change
pattern (changed or remain unchanged) among all overlapping
paths. 

Now, we are able to present an algorithm to detect
changes with low cost. The algorithm probes the overlapping paths with
a high overlap with $\lczd$, keeping a track of those $\cps(q)$ which a probe
detected no change. We use this information to skip others overlapping paths 
with the same $\cps(q)$ in the routing event. \figstr~\ref{fig:savings.comp}
shows a comparative between techniques. The oracle represents an algorithm that
knows exactly where to send a probe in order to detect a change, i.e., 
it is the lower bound, and the sequential algorithm probes all overlapping paths,
i.e., it is the upper bound. We note that our algorithm is near the optimal
for low budget values but becomes stable after a certain budget value
once we are not able to detect overlapping paths that changed in $g(\cps(q))$ that 
are not uniform.  

\ed{We need to improve this part with the following:
\begin{itemize}
    \item Improve the probing process in routing events to probe mixed
    $g(\cps(q))$.
    \item Optimize the probing system by adjust the budget among routing events
    automatically.
    \item Verify if we can apply a new path of overlapping path to others with
    the same $\cps(s)$ in a routing event.
\end{itemize}
}
    


\begin{algorithm}[h]
\caption{Change detection in routing event (\secstr~\ref{sec:patching})}

Sort overlapping paths by $|O|/|\lczd|$ and reverse\;

\textbf{foreach} $\cps(q) \in g(\cps(q))$\textbf{:} 

\Indp
measure(first hop in $\cps(q)$)

\textbf{if} $\cps(q)$ is marked as not changed\textbf{:}
  
    \Indp
    Next overlapping path\;
    \Indm

\textbf{if} changed($\cps(q)$) $=$ False\textbf{:}
    
    \Indp
    Mark $\cps(q)$ as a CPS that does not changed\;
    \Indm

\textbf{else:}
    
    \Indp
    remaprt(overlapping path $q$, ttl($q$,first hop in $\cps(q)$)\;
    \Indm

Next overlapping path\;

\end{algorithm}

% cps cannot detect 5,7\% of changes

\begin{figure}
\begin{center}
\includegraphics[width=1.05\columnwidth]{figs/patching/probchange/probchange.eps}
\caption{Probability of change as a function of overlap size.}
\label{fig:overlap.change.prob}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=1.05\columnwidth]{figs/patching/probcpschange/prob_cps.eps}
\caption{Probability of change of identical CPS inside a same routing event.}
\label{fig:cps.change.prob}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=1.05\columnwidth]{figs/patching/comparative/change_detect.eps}
\caption{Probability of change of identical CPS inside a same routing event.}
\label{fig:savings.comp}
\end{center}
\end{figure}


%\section{Other results}
%
%\begin{figure*}
%\vspace{5mm}
%\begin{minipage}{0.32\textwidth}
%\includegraphics[width=1.05\columnwidth]{figs/patching/probchangezones/zones_changes_overlaps.eps}
%\caption{Distribution of overlaps grouped by overlap sizes split by all overlaps
%and overlaps with changes.}
%\label{fig:zones.overlaps.changes}
%%
%\end{minipage}
%\hfill
%\begin{minipage}{0.32\textwidth}
%\includegraphics[width=1.05\columnwidth]{figs/patching/probchangezones/zones_overlaps_per_intersect.eps}
%\caption{Distribution of overlaps grouped by the fraction of monitored paths
%that overlaps the routing event per overlap size.}
%\label{fig:zones.overlap.detection}
%\end{minipage}
%%
%\hfill
%\begin{minipage}{0.32\textwidth}
%\includegraphics[width=1.05\columnwidth]{figs/patching/probchangezones/zones_changes_per_intersect.eps}
%\caption{Distribution of overlaps \emph{with changes} grouped by the fraction
%of monitored paths that overlaps the routing event per overlap size.}
%\label{fig:zones.changes.detection}
%\end{minipage}
%\end{figure*}
%
%
%
%
%\begin{figure}
%\begin{center}
%\includegraphics[width=1.05\columnwidth]{figs/patching/cpssize/cpssize.eps}
%\caption{CPS size}
%\label{fig:cps.size}
%\end{center}
%\end{figure}
%

% As described in Section~\ref{sec:char}, a path can have more than
% one change. This means that if $E(p_{i-1})$, has more than one
% $\lczd$, the \emph{overlapping paths} can cross different parts of
% $E(p_{i-1})$,.  Thus, we can divide $E(p_{i-1})$, in a more
% fine-grained parts ($\lczd$) which can explain better the
% behaviour of changes in \emph{overlapping paths}. For the rest of
% this section, we consider each $\lczd$ in $E(p_{i-1})$
% independently. 

% As pointed out before, a path change can have more than one
% $\lczd$ and we treat each of them independently in $E_p$.  We now
% formalize how we consider this fact inside \emph{overlapping
% paths}.

%We also looked
%at where the intersection $I$ is located compared to $\lczd$.  We
%find that XX\% of the intersections $I$ are at the start of the
%local change zone (i.e., $r_d + 1$), YY\% of the intersections $I$
%are at the end of the local change zone (i.e., $r_c - 1$), and that
%only ZZ\% of the intersections do are in neither extreme of the
%change zone.

% Let $\lczd'$ denote the local change zone domain of an
% \emph{overlapping path} without $r_d$ and $r_c$ if $|\lczd'_{p}|
% = |\lczd'_{p-1}|$, i.e., $\lczd'$ is the set of hops that reveal
% changes if probed. We define the overlapping change set $OCS
% = \bigcup(\lczd')$ as the set of all hops in the \emph{overlapping
% path} where a probe can detect a change.  


% vim: tw=68
